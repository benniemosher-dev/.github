name: Terraform CI

on:
  workflow_call:
    inputs:
      enable-cloudflare-tfvars:
        default: false
        required: false
        type: boolean
      aws-region:
        default: us-east-1
        required: false
        type: string
      enable-cost:
        default: true
        required: false
        type: boolean
      enable-lint:
        default: true
        required: false
        type: boolean
      enable-security:
        default: true
        required: false
        type: boolean
      enable-terraform:
        default: true
        required: false
        type: boolean
    secrets:
      AWS_ACCOUNT_ID:
        required: false
      KEYBASE_USERNAME:
        required: false
      KEYBASE_PAPERKEY:
        required: false
      INFRACOST_API_KEY:
        required: true
      TF_API_TOKEN:
        required: true

jobs:
  lint-terraform:
    name: Lint Terraform
    uses: "benniemosher-dev/.github/.github/workflows/lint-terraform.yml@main"
    if: ${{ inputs.enable-lint == true }}

  security-terraform:
    name: Security Terraform
    uses: "benniemosher-dev/.github/.github/workflows/sec-terraform.yml@main"
    if: ${{ inputs.enable-security == true }}

  cost-terraform:
    name: Cost Terraform
    uses: "benniemosher-dev/.github/.github/workflows/cost-terraform.yml@bam/add-terraform-workflow"
    if: ${{ inputs.enable-cost == true }}
    secrets:
      INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
      KEYBASE_USERNAME: ${{ secrets.KEYBASE_USERNAME }}
      KEYBASE_PAPERKEY: ${{ secrets.KEYBASE_PAPERKEY }}
    with:
      enable-cloudflare-tfvars: ${{ inputs.enable-cloudflare-tfvars }}

  terraform:
    name: Terraform
    uses: "benniemosher-dev/.github/.github/workflows/terraform.yml@bam/add-terraform-workflow"
    if: ${{ inputs.enable-terraform == true }}
    secrets:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      KEYBASE_USERNAME: ${{ secrets.KEYBASE_USERNAME }}
      KEYBASE_PAPERKEY: ${{ secrets.KEYBASE_PAPERKEY }}
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
    with:
      enable-cloudflare-tfvars: ${{ inputs.enable-cloudflare-tfvars }}
      aws-region: ${{ inputs.aws-region }}
