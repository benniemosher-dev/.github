---
on:
  workflow_call:

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Clone repo
        uses: actions/checkout@v6

      - name: Run tfsec
        uses: aquasecurity/tfsec-sarif-action@v0.1.4
        with:
          sarif_file: tfsec.sarif

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          output_format: cli,sarif
          output_file_path: console,checkov.sarif
          config_file: .checkov.yaml
          # Skip CKV_GHA_7 (unpinned action) - using @main for internal
          # reusable workflows is acceptable
          # Skip CKV2_GHA_1 (top-level permissions) - caller workflows don't
          # need top-level permissions when calling reusable workflows with
          # their own permissions
          skip_check: CKV_GHA_7,CKV2_GHA_1

      - name: Run Terrascan
        id: terrascan
        uses: tenable/terrascan-action@main
        with:
          iac_type: "terraform"
          policy_type: "aws"
          only_warn: true
          sarif_upload: true

      - name: Upload terrascan SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: success() || failure()
        with:
          sarif_file: terrascan.sarif

      - name: Upload Checkov SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: success() || failure()
        with:
          sarif_file: checkov.sarif

      - name: Upload tfsec SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: success() || failure()
        with:
          sarif_file: tfsec.sarif
