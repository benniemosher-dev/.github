---
on:
  workflow_call:

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Clone repo
        uses: actions/checkout@v6

      - name: Run tfsec
        uses: aquasecurity/tfsec-sarif-action@v0.1.4
        with:
          sarif_file: tfsec.sarif

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          output_format: cli,sarif
          output_file_path: console,checkov.sarif
          # Skipped checks - tracked in GitHub issues for future remediation
          # CKV_GHA_7: unpinned actions - using @main for internal workflows
          # CKV2_GHA_1: top-level permissions - caller workflows use reusable
          # CKV_TF_1: module sources need commit hash
          # CKV_AWS_224: ECS cluster logging with CMK
          # CKV_AWS_336: ECS read-only root filesystem
          # CKV_AWS_249: ECS execution/task role ARNs different
          # CKV_AWS_66: CloudWatch retention days specified
          # CKV_AWS_338: CloudWatch 1 year retention
          # CKV_AWS_148: no default VPC provisioned
          # CKV_GIT_4: GitHub secrets encryption
          # CKV_GIT_5: require 2 PR approvals
          skip_check: CKV_GHA_7,CKV2_GHA_1,CKV_TF_1,CKV_AWS_224,CKV_AWS_336,CKV_AWS_249,CKV_AWS_66,CKV_AWS_338,CKV_AWS_148,CKV_GIT_4,CKV_GIT_5

      - name: Run Terrascan
        id: terrascan
        uses: tenable/terrascan-action@main
        with:
          iac_type: "terraform"
          policy_type: "aws"
          only_warn: true
          sarif_upload: true

      - name: Upload terrascan SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: success() || failure()
        with:
          sarif_file: terrascan.sarif

      - name: Upload Checkov SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: success() || failure()
        with:
          sarif_file: checkov.sarif

      - name: Upload tfsec SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: success() || failure()
        with:
          sarif_file: tfsec.sarif
